import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import { GoogleGenerativeAI } from '@google/generative-ai';

const app = express();
app.use(cors());
app.use(express.json());

// โ Gemini API initialization
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

let model;
try {
  model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
} catch (error) {
  console.error("โ Gemini เดฎเตเดกเตฝ เดเตปเดทเดฟเดฏเดฒเตเดธเต เดเตเดฏเตเดฏเดพเตป เดเดดเดฟเดเตเดเดฟเดฒเตเดฒ:", error);
}

// โ Fallback Malayalam jokes
const fallbackJokes = [
  "เดเดคเต เดเดชเตเดชเดพเดคเตเดคเดฟเดฏเดพเดฃเต, เดชเดดเดฏ เดญเตเดฎเดฟเดฏเตเดเต เดเดฟเดคเตเดฐเด เดเดฃเต?",
  "เดชเตเดณเตเดณเดฒเตเดเตพ เดเดฃเตเดเดชเตเดชเตเตพ เดคเตเดจเตเดจเดฟ, เดเดเตเดชเตเดชเดฟเดจเต เดจเตเดฐเต เดฑเตเดเตเดเดฑเตเดฑเต เดเดฑเดเตเดเดฟเดฏเตเดจเตเดจเต!",
  "เดตเตเดคเตเดคเดพเดเดพเดฐเด เดเดพเดฃเดพเตป เดเดฃเตเดฃเดพเดเดฟเดฏเตเด เดตเตเดฃเด!",
  "เดเดจเตเดฆเตเดฐเดเตเดฐเดนเดฃเดคเตเดคเดฟเดจเตเดฑเต เดฌเตเดฃเดธเต เดตเตเตผเดทเตป เดชเตเดฒเต!",
  "เดเดเตเดชเตเดชเดฟเดจเตเดชเตเดชเด เดเตผเดเตเดเต เดเตเดฒเดพเดธเต เดชเตเดฏเดฟเดเตเดเตเดฃเตเดเต?",
  "เดชเตเดณเตเดณเตฝ เดเดเตเดเดจเต เดตเดจเตเดจเดพเตฝ เดเดเตเดชเตเดชเดฟเดจเตเด PTSD เดเดฃเตเดเดพเดเตเด!",
  "เดตเตเดคเตเดคเด เดตเดฐเดฏเตเดเตเดเดพเตป เดธเตเดเตเดฏเดฟเดฒเตเด เดเตเดฎเตเดชเดธเตเด เดฎเดฑเดจเตเดจเต?",
  "เดเดชเตเดชเดพเดคเตเดคเดฟเดเตเดเตโ เดธเตเดตเดจเตเดคเดฎเดพเดฏเดฟ GPS เดตเตเดฃเด, เดตเดดเดฟเดเตเดเดพเดฏเดฟ เดคเตเดจเตเดจเตเดจเตเดจเต!",
  "เดเดคเต เดเดชเตเดชเดพเดคเตเดคเดฟเดฏเต, เดเดฑเตเดคเตเดค เดเดจเตเดฆเตเดฐเตปเตเดฑเต เดธเดฟเดฎเตเดฒเตเดทเตป เดเดฃเต?",
  "เดชเตเดณเตเดณเดฒเตเดเตพเดเตเดเต ISO เดธเตผเดเตเดเดฟเดซเดฟเดเตเดเดฑเตเดฑเต เดเตเดเตเดเตเดเดพเด!"
];

app.post('/api/get-malayalam-comment', async (req, res) => {
  try {
    const { roundness, burn_count } = req.body;
    console.log("๐ฅ เดฒเดญเดฟเดเตเด เดเตปเดชเตเดเตเดเต:", { roundness, burn_count });

    if (!model) {
      console.error("โ Gemini เดฎเตเดกเตฝ เดฑเตเดกเดฟ เดเดฒเตเดฒ.");
      return res.status(500).json({ error: "Gemini เดฎเตเดกเตฝ เดฑเตเดกเดฟ เดเดฒเตเดฒ." });
    }

    if (typeof roundness !== 'number' || typeof burn_count !== 'number') {
      return res.status(400).json({ error: "roundness, burn_count เดจเดฎเตเดชเดฑเดพเดเดฃเด." });
    }

    const prompt = `
เดจเดฟเดเตเดเตพ เดเตเดฐเดณเดคเตเดคเดฟเตฝ เดจเดฟเดจเตเดจเตเดณเตเดณ เดเดฐเต เดเดฒเตเดฏเดพเดฃเดเตเดเดพเดฐเตป, เดชเดฑเตเดฑเดพเดชเตเดชเตเดเดณเตเดเต เดธเดเดธเดพเดฐเดฟเดเตเดเตเดจเตเดจ เดเดฐเต เดธเตเดนเตเดคเตเดคเต.
เดเดฐเต เดเดชเตเดชเดพเดคเตเดคเดฟ เดตเดฟเดถเดเดฒเดจ เดตเดฟเดฆเดเตเดงเดจเดพเดฏเดฟเดเตเดเต, เดเดพเตป เดเตเดเตเดเตเดเตเดจเตเดจ roundness, burn_count เดฎเตเดฒเตเดฏเดเตเดเตพ เดจเตเดเตเดเดฟ
เดเดฟเดฐเดฟเดชเตเดชเดฟเดเตเดเตเดจเตเดจ เดฐเตเดคเดฟเดฏเดฟเตฝ, **เดฎเดฒเดฏเดพเดณเดคเตเดคเดฟเตฝ เดฎเดพเดคเตเดฐเด** เดเดญเดฟเดชเตเดฐเดพเดฏเด เดชเดฑเดฏเดฃเด.

เดจเดฟเดฏเดฎเดเตเดเตพ:
1. เดฎเดฑเตเดชเดเดฟ **เดฎเดฒเดฏเดพเดณเดคเตเดคเดฟเตฝ เดฎเดพเดคเตเดฐเด** เดตเตเดฃเด.
2. เดธเตเดนเตเดคเตเดคเต เดชเตเดฒเต, เดคเดฎเดพเดถเดฏเตเด เดชเตเดเตเดเดฟเดฐเดฟเดฏเตเด เดจเดฟเดฑเดเตเด เดฐเตเดคเดฟเดฏเดฟเตฝ เดธเดเดธเดพเดฐเดฟเดเตเดเตเด.
3. Roundness โ เดเดชเตเดชเดพเดคเตเดคเดฟเดฏเตเดเต เดตเตเดคเตเดคเดพเดเดพเดฐเดคเตเดคเต เดเตเดฑเดฟเดเตเดเต เดชเดฑเดฏเดฃเด.
4. Burn_count โ เดเดคเตเดฐ โเดเดฑเตเดคเตเดคเตเดชเตเดณเตเดณเดฟเดฏโ เดชเดพเดเตเดเตพ เดเดฃเตเดเตเดจเตเดจเต เดชเดฑเดเตเดเต เดเดณเดฟเดฏเดพเดเตเดเดฃเด.
5. เดฎเดฑเตเดชเดเดฟ 1โ3 เดตเดพเดเตเดฏเดเตเดเดณเดฟเตฝ เดเดคเตเดเตเดเดฃเด.

เดเดฆเดพเดนเดฐเดฃเด:
- "เดเดคเต เดเดชเตเดชเดพเดคเตเดคเดฟเดฏเดพเดฃเต, เดเดฒเตเดฒเตเดเตเดเดฟเตฝ เดชเดดเดเดฟเดฏ เดเดจเตเดฆเตเดฐเตปเตเดฑเต เดเดฟเดคเตเดฐเด เดเดฃเต?"
- "เดชเตเดณเตเดณเดฒเตเดเตพ เดเดฃเตเดเดชเตเดชเตเตพ เดคเตเดจเตเดจเดฟ, เดเดเตเดชเตเดชเดฟเดจเต เดจเตเดฐเต เดทเตเดเตเดเต เดเตเดฏเตเดคเตเดจเตเดจเต!"

เดเดชเตเดชเตเตพ, roundness = ${roundness}, burn_count = ${burn_count}.
IMPORTANT: เดฎเดฑเตเดชเดเดฟ เดฎเดฒเดฏเดพเดณเดคเตเดคเดฟเตฝ เดฎเดพเดคเตเดฐเดฎเต เดตเดฐเดฟเด. If you reply in English, your answer will be rejected.
`;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    let text = (response.text() || "").trim();

    // โ Fallback if Gemini gives empty or English text
    if (!text || /[a-zA-Z]/.test(text)) {
      console.warn("โ๏ธ Gemini English/Empty เดฎเดฑเตเดชเดเดฟ เดจเตฝเดเดฟ. Fallback joke เดเดชเดฏเตเดเดฟเดเตเดเตเดจเตเดจเต.");
      text = fallbackJokes[Math.floor(Math.random() * fallbackJokes.length)];
    }

    // โ Ensure UTF-8 output
    res.setHeader('Content-Type', 'application/json; charset=utf-8');
    res.json({ comment: text });

  } catch (error) {
    console.error("โ Gemini API Error:", error);
    const fallback = fallbackJokes[Math.floor(Math.random() * fallbackJokes.length)];
    res.setHeader('Content-Type', 'application/json; charset=utf-8');
    res.status(500).json({ comment: fallback, error: error.message || "Comment generation failed." });
  }
});

const PORT = 5001;
app.listen(PORT, () => console.log(`๐ข Node.js เดธเตเตผเดตเตผ เดชเตเดฐเดตเตผเดคเตเดคเดฟเดเตเดเตเดจเตเดจเต: http://localhost:${PORT}`));
